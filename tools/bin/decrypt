#!/bin/sh

# Check if a file name is provided
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <filename.gpg>"
    exit 1
fi

ENCRYPTED_FILE=$1

# Check if file exists and has .gpg extension
if [ ! -f "$ENCRYPTED_FILE" ] || [ "${ENCRYPTED_FILE##*.}" != "gpg" ]; then
    echo "File not found or not a .gpg file: $ENCRYPTED_FILE"
    exit 1
fi

# Get the file permissions of the encrypted file
PERMISSIONS=$(stat -c %a "$ENCRYPTED_FILE")

# Decrypt the file
gpg --local-user etrnl@etrnl.etrnl --decrypt "$ENCRYPTED_FILE" > "${ENCRYPTED_FILE%.gpg}"

# Check if decryption was successful
if [ $? -eq 0 ]; then
    # Apply the same permissions to the decrypted file
    chmod "$PERMISSIONS" "${ENCRYPTED_FILE%.gpg}"

    # Remove the encrypted file
    rm "$ENCRYPTED_FILE"
else
    echo "Decryption failed for $ENCRYPTED_FILE"
    exit 1
fi
