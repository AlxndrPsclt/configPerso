#!/bin/sh

# Configuration
CONFIG_FILE="/home/alex/.config/perso/tools/bin/config.yml"
DECRYPT_SCRIPT="/home/alex/.config/perso/tools/bin/decrypt" # Replace with the actual path to your encryption script

# Function to read value from YAML file
read_yaml() {
    yq e ".$1" $CONFIG_FILE
}

# Function to download file from IPFS
download_from_ipfs() {
    CID_FILE=$1
    echo "CID_FILE: $CID_FILE"
    FILENAME_AFTER_IPFS_DOWNLOAD=${CID_FILE#@.}
    echo "FILENAME_AFTER_IPFS_DOWNLOAD: $FILENAME_AFTER_IPFS_DOWNLOAD"
    IPFS_NODE=$(read_yaml "ipfs.node_get_address")

    # Read CID from file
    CID=$(cat "$CID_FILE")
    echo "CID: $CID"

    # Download file from IPFS using wget
    echo curl -L "$IPFS_NODE/ipfs/$CID" -o "$FILENAME_AFTER_IPFS_DOWNLOAD"
    curl -L "$IPFS_NODE/ipfs/$CID" -o "$FILENAME_AFTER_IPFS_DOWNLOAD"
    #curl -L "$IPFS_NODE/ipfs/$CID" -o "$FILENAME_AFTER_IPFS_DOWNLOAD"

    # Check if the download was successful
    if [ $? -ne 0 ]; then
        echo "Error: File download from IPFS failed."
        exit 1
    else
        chmod "$PERMISSIONS" "$FILENAME_AFTER_IPFS_DOWNLOAD"
        touch -d "$ORIGINAL_TIME" "$FILENAME_AFTER_IPFS_DOWNLOAD"
    fi

    # Remove CID file
    rm "$CID_FILE"

    if [ "${FILENAME_AFTER_IPFS_DOWNLOAD#.}" != "$FILENAME_AFTER_IPFS_DOWNLOAD" ]; then
      $DECRYPT_SCRIPT "$FILENAME_AFTER_IPFS_DOWNLOAD"
    else
      echo "Error: Filename does not start with ."
    fi

    echo "File downloaded from IPFS and CID file removed."
}

# Main script
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 @..filename.ext"
    exit 1
fi


FILEPATH=$1
echo $FILEPATH

# Extract directory, filename, and extension
DIRPATH=$(dirname "$FILEPATH")
FILENAME=$(basename "$FILEPATH")

# Change to the file's directory
cd "$DIRPATH" || exit

PERMISSIONS=$(stat -c %a "$FILENAME")
ORIGINAL_TIME=$(stat -c %y "$FILENAME")

# Check if the filename starts with '@'
if [ "${FILENAME#@.}" != "$FILENAME" ]; then
    echo "$FILENAME"
    download_from_ipfs "$FILENAME"
else
    echo "Error: Filename does not start with @."
fi

